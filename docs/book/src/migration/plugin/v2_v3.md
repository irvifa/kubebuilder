# Migrating your projects to use v3+ plugins

Make sure you understand the [differences between Kubebuilder v2 and v3](/migration/v2vsv3.md)
before continuing.

Please ensure you have followed the [installation guide](/quick-start.md#installation)
to install the required components.

<aside class="note attention">
<h1>Note</h1>

The most straightforward way to upgrade your project to get all the latest changes and improvements would be to follow the [Migration Guide v2 to V3][migration-guide-v2-to-v3].

</aside>

## Steps to migrate

<aside class="note attention">
<h1>Note</h1>

This guide only covers the breaking and most significant changes in the scaffolds. Note that the following steps
will not migrate the API versions which are deprecated `apiextensions.k8s.io/v1beta1`, `admissionregistration.k8s.io/v1beta1`, `cert-manager.io/v1alpha2`.

</aside>

### Update your plugin version into the PROJECT file

Please ensure you have followed the steps to upgrade your Project version to [v3][project-v3]. Then, update the `layout` setting to the new plugin version ` go.kubebuilder.io/v3` as follows:

```ymal
domain: my.domain
layout: go.kubebuilder.io/v3
projectName: example
repo: example
resources:
- api:
    crdVersion: v1beta
  group: webapp
  kind: Guestbook
  version: v1
  webhooks:
    webhookVersion: v1beta
version: 3-alpha
```

### Upgrade the Go version and its dependencies:  

Ensure that your `go.mod` is using the go version `1.15` as the following dependencies versions:

```
go 1.15

require (
	github.com/go-logr/logr v0.3.0
	github.com/onsi/ginkgo v1.14.1
	github.com/onsi/gomega v1.10.2
	k8s.io/api v0.19.2
	k8s.io/apimachinery v0.19.2
	k8s.io/client-go v0.19.2
	sigs.k8s.io/controller-runtime v0.7.0
)
```

### Update the golang image 

In th Dockerfile, replace:

```
# Build the manager binary
FROM golang:1.13 as builder
```

With:
```
# Build the manager binary
FROM golang:1.15 as builder
```

### Update your Makefile

To allow the tool scaffold the new API versions and use properly the new controller-gen, replace:

```
CRD_OPTIONS ?= "crd:trivialVersions=true"
```

With:

```
CRD_OPTIONS ?= "crd:trivialVersions=true,preserveUnknownFields=false"
```

To allow downloading the newer versions of the K8S binaries required by EnvTest in the `bin/` directory of your project instead of use the globally setup, replace:

```
# Run tests
test: generate fmt vet manifests
	go test ./... -coverprofile cover.out
```

With:

```
# Run tests
ENVTEST_ASSETS_DIR=$(shell pwd)/testbin
test: generate fmt vet manifests
	mkdir -p ${ENVTEST_ASSETS_DIR}
	test -f ${ENVTEST_ASSETS_DIR}/setup-envtest.sh || curl -sSLo ${ENVTEST_ASSETS_DIR}/setup-envtest.sh https://raw.githubusercontent.com/kubernetes-sigs/controller-runtime/v0.7.0/hack/setup-envtest.sh
	source ${ENVTEST_ASSETS_DIR}/setup-envtest.sh; fetch_envtest_tools $(ENVTEST_ASSETS_DIR); setup_envtest_env $(ENVTEST_ASSETS_DIR); go test ./... -coverprofile cover.out
```

<aside class="note warning">
<h1>Note</h1>

The Kubernetes binaries that are required for the EnvTest were upgraded from `1.16.4` to `1.19.2`. You can still install them globally by running: 

```
os=$(go env GOOS)
arch=$(go env GOARCH)

# download kubebuilder and extract it to tmp
curl -LO https://storage.googleapis.com/kubebuilder-tools/kubebuilder-tools-1.19.2-${os}-${arch}.tar.gz | tar -xz -C /tmp/

# move to a long-term location and put it on your path
# (you'll need to set the KUBEBUILDER_ASSETS env var if you put it somewhere else)
sudo mv /tmp/kubebuilder-tools-1.19.2-${os}-${arch}.tar.gz /usr/local/kubebuilder
export PATH=$PATH:/usr/local/kubebuilder/bin
```

</aside>

- Add the following new target to help you undeploy your projects: 

```
# UnDeploy controller from the configured Kubernetes cluster in ~/.kube/config
undeploy:
	$(KUSTOMIZE) build config/default | kubectl delete -f -
```

- Update the `docker-build` target to allow you work easily with podman since Podman prefers options before positional arguments, replace:

```
# Build the docker image
docker-build: test
	docker build . -t ${IMG}
```

With:
```
# Build the docker image
docker-build: test
	docker build -t ${IMG} .
```

<aside class="note warning">
<h1>Note</h1>

For more info see [PR #1817](https://github.com/kubernetes-sigs/kubebuilder/pull/1817).

</aside>

- Update the target that install binaries to get its improvements, replace: 

```
# find or download controller-gen
# download controller-gen if necessary
controller-gen:
ifeq (, $(shell which controller-gen))
	@{ \
	set -e ;\
	CONTROLLER_GEN_TMP_DIR=$$(mktemp -d) ;\
	cd $$CONTROLLER_GEN_TMP_DIR ;\
	go mod init tmp ;\
	go get sigs.k8s.io/controller-tools/cmd/controller-gen@v0.3.0 ;\
	rm -rf $$CONTROLLER_GEN_TMP_DIR ;\
	}
CONTROLLER_GEN=$(GOBIN)/controller-gen
else
CONTROLLER_GEN=$(shell which controller-gen)
endif

kustomize:
ifeq (, $(shell which kustomize))
	@{ \
	set -e ;\
	KUSTOMIZE_GEN_TMP_DIR=$$(mktemp -d) ;\
	cd $$KUSTOMIZE_GEN_TMP_DIR ;\
	go mod init tmp ;\
	go get sigs.k8s.io/kustomize/kustomize/v3@v3.5.4 ;\
	rm -rf $$KUSTOMIZE_GEN_TMP_DIR ;\
	}
KUSTOMIZE=$(GOBIN)/kustomize
else
KUSTOMIZE=$(shell which kustomize)
endif

```

With:
```
# Download controller-gen locally if necessary
CONTROLLER_GEN = $(shell pwd)/bin/controller-gen
controller-gen:
	$(call go-get-tool,$(CONTROLLER_GEN),sigs.k8s.io/controller-tools/cmd/controller-gen@v0.4.1)

# Download kustomize locally if necessary
KUSTOMIZE = $(shell pwd)/bin/kustomize
kustomize:
	$(call go-get-tool,$(KUSTOMIZE),sigs.k8s.io/kustomize/kustomize/v3@v3.8.7)

# go-get-tool will 'go get' any package $2 and install it to $1.
PROJECT_DIR := $(shell dirname $(abspath $(lastword $(MAKEFILE_LIST))))
define go-get-tool
@[ -f $(1) ] || { \
set -e ;\
TMP_DIR=$$(mktemp -d) ;\
cd $$TMP_DIR ;\
go mod init tmp ;\
echo "Downloading $(2)" ;\
GOBIN=$(PROJECT_DIR)/bin go get $(2) ;\
rm -rf $$TMP_DIR ;\
}
endef

```
### Update your controllers

<aside class="note warning">
<h1>Controller-runtime version updated has breaking changes</h1>

Check [sigs.k8s.io/controller-runtime release docs from 0.7.0+ version][controller-releases] for breaking changes.

</aside>

Replace:

```go 
func (r *<MyKind>Reconciler) Reconcile(req ctrl.Request) (ctrl.Result, error) {
    ctx := context.Background() 
	log := r.Log.WithValues("cronjob", req.NamespacedName)
```

With:

```go 
func (r *<MyKind>Reconciler) Reconcile(ctx context.Context, req ctrl.Request) (ctrl.Result, error) {
	log := r.Log.WithValues("cronjob", req.NamespacedName)
```

### Change Logger to use flag options

In the `main.go` file replace: 

```go
flag.Parse()

ctrl.SetLogger(zap.New(zap.UseDevMode(true)))
```

With:

```go
opts := zap.Options{
		Development: true,
	}
	opts.BindFlags(flag.CommandLine)
	flag.Parse()

	ctrl.SetLogger(zap.New(zap.UseFlagOptions(&opts))) 
```

### Rename the manager flags

The manager flags `--metrics-addr` and `enable-leader-election` were renamed for `--metrics-bind-address` and `--leader-elect` to be more aligned with k8s Kubernetes Components. More info: [#1839][issue-1893]. 

In your `main.go` file replace: 


```go
func main() {
	var metricsAddr string
	var enableLeaderElection bool
	flag.StringVar(&metricsAddr, "metrics-addr", ":8080", "The address the metric endpoint binds to.")
	flag.BoolVar(&enableLeaderElection, "enable-leader-election", false,
		"Enable leader election for controller manager. "+
			"Enabling this will ensure there is only one active controller manager.")
```

With: 

```go
var metricsAddr string
	var enableLeaderElection bool
	flag.StringVar(&metricsAddr, "metrics-bind-address", ":8080", "The address the metric endpoint binds to.")
	flag.BoolVar(&enableLeaderElection, "leader-elect", false,
		"Enable leader election for controller manager. "+
			"Enabling this will ensure there is only one active controller manager.")
```

- Then, rename the flags in the `config/default/manager_auth_proxy_patch.yaml` and `config/default/manager.yaml`:

```yaml
- name: manager
args:
- "--health-probe-bind-address=:8081"
- "--metrics-bind-address=127.0.0.1:8080"
- "--leader-elect"
```

### Replace `main.go` import

Replace:

```go
_ "k8s.io/client-go/plugin/pkg/client/auth/gcp"
```

With: 

```go
	// Import all Kubernetes client auth plugins (e.g. Azure, GCP, OIDC, etc.)
	// to ensure that exec-entrypoint and run can make use of them.
	_ "k8s.io/client-go/plugin/pkg/client/auth"
```

### Remove spaces from markers

Remove all spaces use for the markers in the project. 

Replace:
```
// +kubebuilder:
``` 

With:
```
//+kubebuilder:
```

And then, replace:

```
# +kubebuilder
```

With:
```
#+kubebuilder:
```

### Manager Rootless

The projects built with v3+ plugin now define a specific `user ID` and `securityContext` policy to prevent root privilege escalation from the manager container.

- Update your Dockerfile to define an ID for the user used:

Replace:

```
USER nonroot:nonroot
```

With:

```
USER 65532:65532
```

- Update your `manager.yaml` manifests in the `config/manager/` directory by adding:

```yaml
...
spec:
      securityContext:
        runAsUser: 65532
...
```

```yaml
...
name: manager
securityContext:
  allowPrivilegeEscalation: false

```

The final result would look like:

```yaml
...
apiVersion: apps/v1
kind: Deployment
metadata:
  name: controller-manager
  namespace: system
  labels:
    control-plane: controller-manager
spec:
  selector:
    matchLabels:
      control-plane: controller-manager
  replicas: 1
  template:
    metadata:
      labels:
        control-plane: controller-manager
    spec:
      securityContext:
        runAsUser: 65532
      containers:
      - command:
        - /manager
        args:
        - --enable-leader-election
        image: controller:latest
        name: manager
        securityContext:
          allowPrivilegeEscalation: false
        resources:
          limits:
            cpu: 100m
            memory: 30Mi
          requests:
            cpu: 100m
            memory: 20Mi
      terminationGracePeriodSeconds: 10
```

### Add the Liveness and Readiness probes

From now on, the new projects build with the tool will be scaffolding Liveness and Readiness probes using [`healthz.Ping`][healthz-ping]. To add them to your project update your `main.go file:

- By adding the new flag `--health-probe-bind-address`:

```go
func main() {
	var metricsAddr string
	var enableLeaderElection bool
	var probeAddr string
	flag.StringVar(&metricsAddr, "metrics-bind-address", ":8080", "The address the metric endpoint binds to.")
	flag.StringVar(&probeAddr, "health-probe-bind-address", ":8081", "The address the probe endpoint binds to.")
	...
``` 

- By using the new flag in the manager: 

```go 
mgr, err := ctrl.NewManager(ctrl.GetConfigOrDie(), ctrl.Options{
		Scheme:                 scheme,
		MetricsBindAddress:     metricsAddr,
		Port:                   9443,
		HealthProbeBindAddress: probeAddr,
		LeaderElection:         enableLeaderElection,
		LeaderElectionID:       "dd1da13f.testproject.org",
	})
	if err != nil {
		setupLog.Error(err, "unable to start manager")
		os.Exit(1)
	}
```

- Then, add the new probe endpoints after the Manager is initialized:

```go

	if err := mgr.AddHealthzCheck("healthz", healthz.Ping); err != nil {
		log.Error(err, "Unable to set up health check")
		os.Exit(1)
	}

	if err := mgr.AddReadyzCheck("readyz", healthz.Ping); err != nil {
		log.Error(err, "Unable to set up ready check")
		os.Exit(1)
	}

```

Finally, update the `config/manager/manager.yaml` to add the probes:

```yaml
      name: manager
          securityContext:
            allowPrivilegeEscalation: false
      livenessProbe:
          httpGet:
            path: /healthz
            port: 8081
          initialDelaySeconds: 15
          periodSeconds: 20
        readinessProbe:
          httpGet:
            path: /readyz
            port: 8081
          initialDelaySeconds: 5
          periodSeconds: 10
```

### Roles (RBAC) bug fixes

From now on, the scaffolded roles include finalizer permissions ([more info](https://github.com/kubernetes-sigs/kubebuilder/issues/1654)). Feel free to add them to your projects. As an example:

```yaml
...
- apiGroups:
  - webapp.my.domain
  resources:
  - guestbooks/finalizers
  verbs:
  - update
...
```

Also, the following `configmaps/status` permission is no longer scaffolded since they are invalid. Feel free to remove it from your `role.yaml` file in `config/rbac/` directory:

```yaml
...
  resources:
  - configmaps/status
  verbs:
  - get
  - update
  - patch
```

### Verification

Finally, we can run `make` and `make docker-build` to ensure things are working
fine.

## Migrate your API versions

Make sure you understand [Versions in CustomResourceDefinitions](https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definition-versioning/)
before continuing.

<aside class="note warning">
<h1>Note</h1>

Currently, the tool does not allow working with both version of APIs for your resources.

</aside>

The following steps try to describe a workaround for you to be able to upgrade your CRDs and Webhooks.  

The first step would be update your PROJECT file by replacing the `api.crdVersion:v1beta` and `webhooks.WebhookVersion:v1beta` with `api.crdVersion:v1` and `webhooks.WebhookVersion:v1` which would like: 

```ymal
domain: my.domain
layout: go.kubebuilder.io/v3
projectName: example
repo: example
resources:
- api:
    crdVersion: v1
  group: webapp
  kind: Guestbook
  version: v1
  webhooks:
    webhookVersion: v1
version: 3-alpha
```

Now, you can try to re-create APIS(CRDs) and Webhooks manifests by running the commands `kubebuilder create api` and `kubebuilder create webhook` for the same group, kind and versions with the flag `--force`.   

However, note that the tool will re-scaffold the files which means that you will lose your content. So, before executing the commands be sure that you have its content saved in another place. 

[healthz-ping]: https://pkg.go.dev/sigs.k8s.io/controller-runtime/pkg/healthz#CheckHandler 
[controller-releases]: https://github.com/kubernetes-sigs/controller-runtime/releases
[issue-1893]: https://github.com/kubernetes-sigs/kubebuilder/issues/1839
[migration-guide-v2-to-v3]: ../migration_guide_v2tov3.md
[project-v3]: /migration/project/v2_v3.md